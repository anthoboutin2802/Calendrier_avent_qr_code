<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Debug — Message vocal + image</title>
  <style>
    body {
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      display:flex;
      flex-direction:column;
      min-height:100vh;
      align-items:center;
      justify-content:flex-start;
      padding-top:20px;
      background:#111;
      color:#fff;
    }
    .card {
      max-width:920px;
      width:100%;
      padding:16px;
      box-sizing:border-box;
      text-align:center;
    }
    img {
      max-width:100%;
      height:auto;
      border-radius:8px;
      box-shadow:0 6px 18px rgba(0,0,0,0.6);
    }
    h1 {
      margin:12px 0 6px 0;
      font-size:1.4rem;
    }
    button {
      margin-top:12px;
      padding:12px 18px;
      font-size:1rem;
      border-radius:8px;
      border:none;
      cursor:pointer;
      background:#1a73e8;
      color:#fff;
    }
    #debugBox {
      margin-top:20px;
      padding:15px;
      width:90%;
      max-width:900px;
      background:#222;
      border-radius:10px;
      text-align:left;
      font-size:0.9rem;
      line-height:1.4rem;
      white-space:pre-wrap;
      word-break:break-word;
    }
    a { color:#7abaff; }
  </style>
</head>
<body>
  <div class="card">
    <img id="poster" alt="Image" src="" />
    <h1 id="dayLabel">[date]</h1>

    <audio id="audio" src="" preload="auto"></audio>

    <button id="playBtn" style="display:none">▶️ Appuyer pour lancer l'audio</button>

    <div id="debugBox">
      <strong>DEBUG MODE :</strong>
      <div id="debugContent">Chargement...</div>
    </div>
  </div>

<script>
function getParam(name){
  const url = new URL(window.location.href);
  return url.searchParams.get(name);
}

// Nouveaux chemins locaux
function imgUrl(filename) {
  return "assets/img/" + encodeURIComponent(filename);
}

function audioUrl(filename) {
  return "assets/audio/" + encodeURIComponent(filename);
}

async function tryAutoplay(audioEl){
  try{
    await audioEl.play();
    return true;
  }catch(e){
    return false;
  }
}

function logDebug(msg) {
  const box = document.getElementById('debugContent');
  box.innerHTML += "\n" + msg;
}

window.addEventListener('DOMContentLoaded', async ()=>{
  const imgParam = getParam('img');
  const audioParam = getParam('audio');
  const dayParam = getParam('day');

  const poster = document.getElementById('poster');
  const audioEl = document.getElementById('audio');
  const dayLabel = document.getElementById('dayLabel');
  const playBtn = document.getElementById('playBtn');

  logDebug("Paramètres reçus :");
  logDebug("img = " + imgParam);
  logDebug("audio = " + audioParam);
  logDebug("day = " + dayParam);

  if(!imgParam || !audioParam){
    logDebug("❌ Paramètres manquants, impossible de charger les assets.");
    return;
  }

  const imgSrc = imgUrl(imgParam);
  const audioSrc = audioUrl(audioParam);

  logDebug("\n→ URLs générées :");
  logDebug("Image URL = " + imgSrc);
  logDebug("Audio URL = " + audioSrc);

  // Affichage date
  dayLabel.textContent = dayParam;

  // Chargement image
  poster.src = imgSrc;

  poster.onload = () => logDebug("✔️ Image chargée avec succès.");
  poster.onerror = () => logDebug("❌ ERREUR : Impossible de charger l'image : " + imgSrc);

  // Chargement audio
  audioEl.src = audioSrc;

  audioEl.addEventListener("loadeddata", () => {
    logDebug("✔️ Audio chargé (metadata OK).");
  });

  audioEl.addEventListener("canplaythrough", () => {
    logDebug("✔️ Audio prêt à lire.");
  });

  audioEl.addEventListener("error", () => {
    logDebug("❌ ERREUR AUDIO : impossible de charger " + audioSrc);
  });

  // Autoplay test
  const autoplaySucceeded = await tryAutoplay(audioEl);

  if(autoplaySucceeded){
    logDebug("✔️ Autoplay a fonctionné.");
  } else {
    logDebug("⚠️ Autoplay bloqué par le navigateur.");
    playBtn.style.display = "inline-block";
    playBtn.addEventListener('click', async ()=>{
      logDebug("⏯️ Tentative de lecture manuelle...");
      try{
        await audioEl.play();
        logDebug("✔️ Audio lancé manuellement.");
        playBtn.style.display = "none";
      }catch(err){
        logDebug("❌ ERREUR : échec de lecture manuelle.");
      }
    });
  }
});
</script>
</body>
</html>
