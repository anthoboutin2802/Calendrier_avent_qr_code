<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calendrier de l'Avent</title>
  <style>
    body {
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      display:flex;
      flex-direction:column;
      min-height:100vh;
      align-items:center;
      justify-content:center;
      padding-top:20px;
      background:#111;
      color:#fff;
    }
    .card {
      max-width:900px;
      width:95%;
      padding:16px;
      box-sizing:border-box;
      text-align:center;
    }
    img {
      max-width:100%;
      height:auto;
      border-radius:12px;
      box-shadow:0 6px 18px rgba(0,0,0,0.6);
    }
    h1 {
      margin:12px 0 6px 0;
      font-size:1.4rem;
    }
    #playBtn {
      margin-top:12px;
      padding:12px 18px;
      font-size:1rem;
      border-radius:8px;
      border:none;
      cursor:pointer;
      background:#1a73e8;
      color:#fff;
      display:none;
    }
    #hint {
      margin-top:10px;
      opacity:0.9;
      font-size:0.95rem;
    }
  </style>
</head>
<body>
  <div class="card">
    <img id="poster" alt="Image" src="" />
    <h1 id="dayLabel">[Jour]</h1>

    <audio id="audio" preload="auto"></audio>

    <button id="playBtn">▶️ Appuyer pour lancer l'audio</button>
    <div id="hint"></div>
  </div>

<script>
function getParam(name){
  const url = new URL(window.location.href);
  return url.searchParams.get(name);
}

function imgUrl(filename) {
  return "assets/img/" + encodeURIComponent(filename);
}

function audioUrl(filename) {
  return "assets/audio/" + encodeURIComponent(filename);
}

async function tryAutoplay(audioEl){
  try{
    await audioEl.play();
    return true;
  }catch(e){
    return false;
  }
}

window.addEventListener('DOMContentLoaded', async ()=>{
  const imgParam = getParam('img');
  const audioParam = getParam('audio');
  const dayParam = getParam('day');

  const poster = document.getElementById('poster');
  const audioEl = document.getElementById('audio');
  const dayLabel = document.getElementById('dayLabel');
  const playBtn = document.getElementById('playBtn');
  const hint = document.getElementById('hint');

  if(!imgParam || !audioParam){
    dayLabel.textContent = "Erreur";
    hint.textContent = "Les paramètres du lien QR sont incomplets.";
    return;
  }

  // URLs locales
  const imgSrc = imgUrl(imgParam);
  const audioSrc = audioUrl(audioParam);

  // Set content
  poster.src = imgSrc;
  audioEl.src = audioSrc;
  dayLabel.textContent = "Jour " + dayParam;

  // Image error
  poster.onerror = () => {
    hint.textContent = "Impossible de charger l'image.";
  };

  // Audio load errors
  audioEl.onerror = () => {
    hint.textContent = "Impossible de charger le fichier audio.";
  };

  // Autoplay
  const autoplaySucceeded = await tryAutoplay(audioEl);

  if(autoplaySucceeded){
    hint.textContent = "Lecture automatique.";
  } else {
    hint.textContent = "Lecture automatique bloquée, appuyez sur ▶️";
    playBtn.style.display = "inline-block";
    playBtn.addEventListener('click', async ()=>{
      try{
        await audioEl.play();
        hint.textContent = "Lecture en cours…";
        playBtn.style.display = "none";
      }catch(err){
        hint.textContent = "Impossible de lire le fichier audio.";
      }
    });
  }
});
</script>
</body>
</html>
