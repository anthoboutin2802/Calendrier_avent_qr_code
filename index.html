<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calendrier de l'Avent d'Estelle</title>
  <style>
    body {
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      display:flex;
      flex-direction:column;
      min-height:100vh;
      align-items:center;
      justify-content:center;
      padding-top:20px;
      background:#111;
      color:#fff;
    }
    h2 {
      margin:0 0 20px 0;
      font-size:1.8rem;
      color:#f5d142;
      text-shadow:0 0 8px rgba(255,255,255,0.5);
    }
    .card {
      max-width:900px;
      width:95%;
      padding:16px;
      box-sizing:border-box;
      text-align:center;
    }
    img {
      max-width:100%;
      height:auto;
      border-radius:12px;
      box-shadow:0 6px 18px rgba(0,0,0,0.6);
      margin-bottom:15px;
    }
    h1 {
      margin:0 0 12px 0;
      font-size:1.6rem;
    }
    button {
      margin:8px;
      padding:12px 18px;
      font-size:1rem;
      border-radius:8px;
      border:none;
      cursor:pointer;
      background:#1a73e8;
      color:#fff;
    }
    #replayBtn {
      background:#28a745;
    }
    #hint {
      margin-top:10px;
      opacity:0.9;
      font-size:0.95rem;
    }
  </style>
</head>
<body>

  <!-- Nouveau titre principal -->
  <h2>Calendrier de l'avent d'Estelle üéÑ</h2>

  <div class="card">
    <h1 id="dayLabel">[Jour]</h1>

    <img id="poster" alt="Image" src="" />

    <audio id="audio" preload="auto"></audio>

    <button id="playBtn" style="display:none">‚ñ∂Ô∏è Lancer l'audio</button>
    <button id="replayBtn" style="display:none">üîÅ Rejouer</button>

    <div id="hint"></div>
  </div>

<script>
function getParam(name){
  const url = new URL(window.location.href);
  return url.searchParams.get(name);
}

function imgUrl(filename) {
  return "assets/img/" + encodeURIComponent(filename);
}

function audioUrl(filename) {
  return "assets/audio/" + encodeURIComponent(filename);
}

// Convertit "01" ‚Üí "1er D√©cembre", "02" ‚Üí "2 D√©cembre", etc.
function formatFrenchDate(day) {
  const n = parseInt(day, 10);
  if (n === 1) return "1er D√©cembre";
  return n + " D√©cembre";
}

async function tryAutoplay(audioEl){
  try{
    await audioEl.play();
    return true;
  }catch(e){
    return false;
  }
}

window.addEventListener('DOMContentLoaded', async ()=>{
  const imgParam = getParam('img');
  const audioParam = getParam('audio');
  const dayParam = getParam('day');

  const poster = document.getElementById('poster');
  const audioEl = document.getElementById('audio');
  const dayLabel = document.getElementById('dayLabel');
  const playBtn = document.getElementById('playBtn');
  const replayBtn = document.getElementById('replayBtn');
  const hint = document.getElementById('hint');

  if(!imgParam || !audioParam){
    dayLabel.textContent = "Erreur";
    hint.textContent = "Les param√®tres du QR code sont incomplets.";
    return;
  }

  // Format du jour
  dayLabel.textContent = formatFrenchDate(dayParam);

  const imgSrc = imgUrl(imgParam);
  const audioSrc = audioUrl(audioParam);

  poster.src = imgSrc;
  audioEl.src = audioSrc;

  poster.onerror = () => {
    hint.textContent = "Impossible de charger l'image.";
  };

  audioEl.onerror = () => {
    hint.textContent = "Impossible de charger le fichier audio.";
  };

  // Bouton rejouer
  replayBtn.addEventListener('click', async ()=>{
    try {
      audioEl.currentTime = 0;
      await audioEl.play();
      hint.textContent = "Lecture en cours‚Ä¶";
    } catch (err) {
      hint.textContent = "Impossible de lire l'audio.";
    }
  });

  // Tentative d'autoplay
  const autoplaySucceeded = await tryAutoplay(audioEl);

  replayBtn.style.display = "inline-block";

  if(autoplaySucceeded){
    hint.textContent = "Lecture automatique.";
  } else {
    hint.textContent = "Lecture automatique bloqu√©e. Appuyez sur ‚ñ∂Ô∏è";
    playBtn.style.display = "inline-block";

    playBtn.addEventListener('click', async ()=>{
      try{
        await audioEl.play();
        hint.textContent = "Lecture en cours‚Ä¶";
        playBtn.style.display = "none";
      }catch(err){
        hint.textContent = "Impossible de lire l'audio.";
      }
    });
  }
});
</script>
</body>
</html>
